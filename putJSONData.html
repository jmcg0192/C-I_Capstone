<!DOCTYPE html>
<html lang="en">
<head>
  <title>Search & Submit Songs</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS & JS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { font-family: 'Roboto', sans-serif; padding: 20px; }
    .top-bar { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 10px; 
      margin-bottom: 20px; 
    }
    .toggle-container { text-align: center; margin-bottom: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    .search-section { 
      padding: 20px; 
      border: 1px solid #ccc; 
      border-radius: 5px; 
      margin-bottom: 20px; 
    }
    .album img { max-width: 150px; border-radius: 5px; margin-bottom: 10px; }
    .song { margin-bottom: 10px; }
  </style>
</head>
<body>

  <!-- Top Bar with User Profile / Login Button -->
  <div class="top-bar">
    <h1>Search for a Song or Album</h1>
    <div id="userArea">
      <button id="loginButton" class="btn btn-outline-primary" onclick="openLoginModal()">Login Here</button>
    </div>
  </div>

  <!-- Toggle for Search Mode -->
  <div class="toggle-container">
    <div class="btn-group" role="group" aria-label="Search Mode">
      <input type="radio" class="btn-check" name="searchMode" id="searchModeSong" value="song" autocomplete="off" checked>
      <label class="btn btn-outline-primary" for="searchModeSong">Song</label>
      
      <input type="radio" class="btn-check" name="searchMode" id="searchModeAlbum" value="album" autocomplete="off">
      <label class="btn btn-outline-primary" for="searchModeAlbum">Album</label>
    </div>
  </div>

  <!-- Search Container -->
  <div class="container">
    <!-- Song Search Section -->
    <div id="songSearchSection" class="search-section">
      <h2>Search by Song</h2>
      <input type="text" id="songSearchInput" class="form-control mb-2" placeholder="Enter song name">
      <button class="btn btn-primary w-100" onclick="searchSongs()">Search Song</button>
      <div id="songResults"></div>
    </div>
    
    <!-- Album Search Section (initially hidden) -->
    <div id="albumSearchSection" class="search-section" style="display: none;">
      <h2>Search by Album</h2>
      <input type="text" id="albumSearchInput" class="form-control mb-2" placeholder="Enter album name">
      <input type="text" id="albumArtistInput" class="form-control mb-2" placeholder="Enter artist name (optional)">
      <button class="btn btn-primary w-100" onclick="searchAlbums()">Search Album</button>
      <div id="albumResults"></div>
    </div>
  </div>

  <!-- Submit Selected Song (Login Required) -->
  <h2 class="text-center mt-4">Submit Your Selected Song</h2>
  <button class="btn btn-success d-block mx-auto" onclick="attemptSubmit()">Submit Selected Song</button>
  <div id="response" class="text-center mt-2"></div>

  <!-- Login & Signup Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Login Form -->
          <div id="login-container">
            <input type="text" id="loginUsername" placeholder="Username" class="form-control mb-2">
            <input type="password" id="loginPassword" placeholder="Password" class="form-control mb-2">
            <button class="btn btn-primary w-100" onclick="login()">Login</button>
            <p id="loginErrorMessage" style="color: red; display: none;"></p>
          </div>
          <!-- New Account Form (Initially Hidden) -->
          
  <div id="newAccountContainer" style="display: none;">
    <h5>Create New Account</h5>
    <input type="text" id="newUsername" placeholder="Username" class="form-control mb-2">
    <input type="password" id="newPassword" placeholder="Password" class="form-control mb-2">
    <input type="email" id="email" placeholder="Email" class="form-control mb-2">
    <select id="role" class="form-control mb-2">
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select>
    <button class="btn btn-success w-100" onclick="createAccount()">Create Account</button>
  </div>
        </div>
      </div>
    </div>
  </div>

  <!-- External scripts for JSONBin operations -->
  <script src="getJSONData.js"></script>
  <script src="putJSONData.js"></script>

  <script>
    let selectedSong = null;
    let loggedInUser = null;

    // Toggle between Song and Album search sections
    document.getElementById('searchModeSong').addEventListener('change', function(){
      document.getElementById('songSearchSection').style.display = 'block';
      document.getElementById('albumSearchSection').style.display = 'none';
    });
    document.getElementById('searchModeAlbum').addEventListener('change', function(){
      document.getElementById('songSearchSection').style.display = 'none';
      document.getElementById('albumSearchSection').style.display = 'block';
    });

    // Open login modal and reset to show the login form
    function openLoginModal() {
      document.getElementById('login-container').style.display = 'block';
      document.getElementById('newAccountContainer').style.display = 'none';
      document.getElementById('loginErrorMessage').style.display = 'none';
      new bootstrap.Modal(document.getElementById('loginModal')).show();
    }

    // Search for songs using the iTunes API
    async function searchSongs() {
      const query = document.getElementById('songSearchInput').value;
      const resultsDiv = document.getElementById('songResults');

      if (!query) {
        alert('Please enter a song name!');
        return;
      }

      resultsDiv.innerHTML = '<p>Loading...</p>';

      try {
        const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&limit=5&entity=song`);
        const data = await response.json();
        resultsDiv.innerHTML = data.results.length === 0 ? '<p>No songs found.</p>' : '';
        data.results.forEach(song => {
          resultsDiv.innerHTML += `
            <div class="song">
              <p><strong>${song.trackName}</strong> - ${song.artistName}</p>
              <audio controls>
                <source src="${song.previewUrl}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
              <button class="btn btn-sm btn-outline-primary" onclick="selectSong('${song.trackName}', '${song.artistName}', '${song.collectionName}', '${song.artworkUrl100}')">Select</button>
            </div>`;
        });
      } catch (error) {
        resultsDiv.innerHTML = '<p>Error fetching results.</p>';
        console.error(error);
      }
    }

    // Search for albums using the iTunes API with an optional artist field
    async function searchAlbums() {
      const albumQuery = document.getElementById('albumSearchInput').value;
      const artistQuery = document.getElementById('albumArtistInput').value;
      const resultsDiv = document.getElementById('albumResults');

      if (!albumQuery) {
        alert('Please enter an album name!');
        return;
      }
      
      let query = encodeURIComponent(albumQuery);
      if (artistQuery) {
        query += '+' + encodeURIComponent(artistQuery);
      }
      
      resultsDiv.innerHTML = '<p>Loading...</p>';
      try {
        const response = await fetch(`https://itunes.apple.com/search?term=${query}&limit=5&entity=album`);
        const data = await response.json();
        resultsDiv.innerHTML = data.results.length === 0 ? '<p>No albums found.</p>' : '';
        data.results.forEach(album => {
          resultsDiv.innerHTML += `
            <div class="album">
              <h3>${album.collectionName} - ${album.artistName}</h3>
              <img src="${album.artworkUrl100}" alt="Album Cover">
              <br>
              <button id="toggle-songs-btn-${album.collectionId}" class="btn btn-sm btn-outline-primary"
                onclick="fetchAlbumTracks('${album.collectionId}', '${album.collectionName}', '${album.artistName}', '${album.artworkUrl100}')">
                View Songs
              </button>
              <div id="songs-${album.collectionId}" style="display: none;"></div>
            </div>`;
        });
      } catch (error) {
        resultsDiv.innerHTML = '<p>Error fetching albums.</p>';
        console.error(error);
      }
    }

    // Fetch tracks for a specific album and allow toggling the view; songs are playable.
    async function fetchAlbumTracks(albumId, albumName, artistName, albumArt) {
      const songsDiv = document.getElementById(`songs-${albumId}`);
      const button = document.getElementById(`toggle-songs-btn-${albumId}`);

      // If songs are already loaded, toggle display.
      if (songsDiv.innerHTML.trim() !== "" && songsDiv.innerHTML.indexOf("Loading") === -1) {
        if (songsDiv.style.display === "none" || !songsDiv.style.display) {
          songsDiv.style.display = "block";
          button.textContent = "Hide Songs";
        } else {
          songsDiv.style.display = "none";
          button.textContent = "View Songs";
        }
        return;
      }

      songsDiv.innerHTML = '<p>Loading songs...</p>';
      try {
        const response = await fetch(`https://itunes.apple.com/lookup?id=${albumId}&entity=song`);
        const data = await response.json();
        songsDiv.innerHTML = `<h4>Songs from ${albumName}</h4>`;
        data.results.slice(1).forEach(song => {
          songsDiv.innerHTML += `
            <div class="song">
              <p><strong>${song.trackName}</strong></p>
              <audio controls>
                <source src="${song.previewUrl}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
              <button class="btn btn-sm btn-outline-primary" onclick="selectSong('${song.trackName}', '${artistName}', '${albumName}', '${albumArt}')">Select</button>
            </div>`;
        });
        songsDiv.style.display = "block";
        button.textContent = "Hide Songs";
      } catch (error) {
        songsDiv.innerHTML = '<p>Error loading songs.</p>';
        console.error(error);
      }
    }

    // Save the selected song and notify the user.
    function selectSong(track, artist, album, albumArt) {
      selectedSong = { track, artist, album, albumArt };
      alert(`Selected: ${track} by ${artist}`);
    }

    // Attempt to submit the selected song; if not logged in, prompt login modal.
    function attemptSubmit() {
      if (!selectedSong) {
        alert("You must select a song before submitting!");
        return;
      }
      if (!loggedInUser) {
        alert("You must log in before submitting!");
        openLoginModal();
      } else {
        alert("Song submitted successfully!");
      }
    }

    // Login function: uses Username and Password; if not found, prompts signup.
    async function login() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      try {
        const data = await getJSONData();
        const users = JSON.parse(data);
        loggedInUser = users.find(user => user.Username === username && user.Password === password);
        if (loggedInUser) {
          alert("Login Successful");
          document.getElementById('userArea').innerHTML = `<button class="btn btn-outline-secondary" onclick="showUserProfile()">Welcome, ${loggedInUser.Username} (${loggedInUser.Role})</button>`;
          new bootstrap.Modal(document.getElementById('loginModal')).hide();
        } else {
          document.getElementById('loginErrorMessage').textContent = "Account not found. Please create a new one.";
          document.getElementById('loginErrorMessage').style.display = 'block';
          document.getElementById('login-container').style.display = 'none';
          document.getElementById('newAccountContainer').style.display = 'block';
        }
      } catch (error) {
        console.error("Login error:", error);
      }
    }
    
    

    // Create a new account using Username, Password, and Email.
     async function createAccount() {
      const newUsername = document.getElementById('newUsername').value;
      const newPassword = document.getElementById('newPassword').value;
      const email = document.getElementById('email').value;
      const role = document.getElementById('role').value;
      
      if (newUsername && newPassword && email.includes("@")) {
        const newUser = { Username: newUsername, Password: newPassword, Email: email, Role: role };
        try {
          const data = await getJSONData();
          const users = JSON.parse(data);
          users.push(newUser);
          await putJSONData(users);
          alert("Account created successfully!");
          loggedInUser = newUser;
          document.getElementById('userArea').innerHTML = `<button class="btn btn-outline-secondary" onclick="showUserProfile()">Welcome, ${loggedInUser.Username} (${loggedInUser.Role})</button>`;
          new bootstrap.Modal(document.getElementById('loginModal')).hide();
        } catch (error) {
          console.error("Account creation error:", error);
        }
      } else {
        alert("All fields are required, and email must contain '@'.");
      }
    }

    // (Optional) Function to show user profile details.
    function showUserProfile() {
      alert(`User Profile:\nUsername: ${loggedInUser.Username}\nEmail: ${loggedInUser.Email}`);
    }
  </script>

</body>
</html>
