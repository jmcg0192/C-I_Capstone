<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recommendations - Jukeboxd</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { background-color: #121212; color: #f1f1f1; font-family: 'Roboto', sans-serif; margin: 0; }
    .navbar { background-color: #1f1f1f; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); }
    .navbar-brand { font-size: 1.5rem; font-weight: bold; color: #00b894; }
    .navbar-nav .nav-link { color: #ccc; margin-right: 1rem; }
    .navbar-nav .nav-link:hover { color: #fff; }
    .container { margin-top: 2rem; }
    .tab-content { margin-top: 2rem; }
    .section-title { text-align: center; margin-bottom: 2rem; font-weight: bold; color: #00b894; }
    .card { background-color: #1f1f1f; border: none; border-radius: 10px; overflow: hidden; transition: transform 0.3s; }
    .card-body {
      color: #ffffff; }
    .card:hover { transform: scale(1.05); }
    .card-img-top { height: 200px; object-fit: cover; }
    .btn-primary { background-color: #00b894; border: none; }
    .btn-primary:hover { background-color: #019670; }
    .nav-tabs .nav-link { background: transparent; border: none; color: #ccc; }
    .nav-tabs .nav-link.active { color: #00b894; border-bottom: 2px solid #00b894; }
    .recommendation-section { padding: 20px; }
    .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid #00b894; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Jukeboxd</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
        <li class="nav-item"><a class="nav-link" href="songsearch.html">Search</a></li>
        <li class="nav-item"><a class="nav-link" href="jukebox.html">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container recommendation-section">
  <ul class="nav nav-tabs" id="recommendationTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="personalized-tab" data-bs-toggle="tab" data-bs-target="#personalized" type="button" role="tab">
        Personalized Recommendations
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="trending-tab" data-bs-toggle="tab" data-bs-target="#trending" type="button" role="tab">
        Trending Now
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="discover-tab" data-bs-toggle="tab" data-bs-target="#discover" type="button" role="tab">
        Discover New Music
      </button>
    </li>
  </ul>

  <div class="tab-content" id="recommendationTabContent">
    <div class="tab-pane fade show active" id="personalized" role="tabpanel">
      <h2 class="section-title">Based on Your Selections</h2>
      <div id="personalizedContent">
        <p class="text-center">Please log in to see personalized recommendations.</p>
      </div>
    </div>

    <div class="tab-pane fade" id="trending" role="tabpanel">
      <h2 class="section-title">What's Hot Right Now</h2>
      <div class="row" id="trendingSongsContent">
        <div class="loader"></div>
      </div>
      <div class="pagination-controls text-center mt-3" id="songsPagination">
        <button class="btn btn-outline-primary" id="loadMoreSongs" onclick="loadMoreTrendingSongs()">Load 10 More</button>
      </div>
    </div>

    <div class="tab-pane fade" id="discover" role="tabpanel">
      <h2 class="section-title">Discover By Genre</h2>
      <div class="mb-4">
        <select id="genreSelect" class="form-select">
          <option value="all">All Genres</option>
          <option value="pop">Pop</option>
          <option value="rock">Rock</option>
          <option value="hiphop">Hip Hop/Rap</option>
          <option value="electronic">Electronic</option>
          <option value="jazz">Jazz</option>
          <option value="classical">Classical</option>
          <option value="country">Country</option>
          <option value="rnb">R&B/Soul</option>
        </select>
        <button class="btn btn-primary w-100 mt-2" onclick="discoverByGenre()">Discover</button>
      </div>
      <div id="discoverContent"></div>
    </div>
  </div>
</div>

<div id="userArea"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="getJSONData.js"></script>
<script src="putJSONData.js"></script>
<script>
let loggedInUser = sessionStorage.getItem('loggedInUser') ? JSON.parse(sessionStorage.getItem('loggedInUser')) : null;
let selectedSong = null;
let selectedAlbum = null;
let trendingSongsPage = 1;
let trendingSongsData = [];
const itemsPerPage = 10;

window.addEventListener('DOMContentLoaded', () => {
  updateUserArea();
  if (loggedInUser) loadPersonalizedRecommendations();
  document.getElementById('trending-tab').addEventListener('click', () => {
    if (trendingSongsData.length === 0) loadTrendingSongs();
  });
});

function updateUserArea() {
  const userArea = document.getElementById('userArea');
  userArea.innerHTML = '';
}

async function loadTrendingSongs() {
  const div = document.getElementById('trendingSongsContent');
  div.innerHTML = '<div class="loader"></div>';
  try {
    const res = await fetch('https://itunes.apple.com/us/rss/topsongs/limit=100/json');
    const data = await res.json();
    trendingSongsData = data.feed.entry || [];
    renderTrendingSongs(0, itemsPerPage);
    updateSongsPagination();
  } catch (e) {
    div.innerHTML = '<p class="text-center">Error loading trending songs.</p>';
  }
}

function renderTrendingSongs(start, count) {
  const div = document.getElementById('trendingSongsContent');
  div.innerHTML = '';
  const slice = trendingSongsData.slice(start, start + count);
  if (slice.length === 0) {
    div.innerHTML = '<p class="text-center">No songs available.</p>';
    return;
  }
  slice.forEach(item => {
    const title = item.title.label;
    const artist = item['im:artist'].label;
    const img = item['im:image'][2].label;
    const genre = item.category.attributes.term;
    div.innerHTML += `
      <div class="col-md-4 mb-4">
        <div class="card h-100">
          <img src="${img}" class="card-img-top" alt="${title}">
          <div class="card-body">
            <h5 class="card-title">${title}</h5>
            <p class="card-text">Artist: ${artist}</p>
            <p class="card-text">Genre: ${genre}</p>
            <button class="btn btn-primary" onclick="searchAndPreview('${title.replace(/'/g, "\'")}', '${artist.replace(/'/g, "\'")}')">Listen Preview</button>
          </div>
        </div>
      </div>`;
  });
}

function updateSongsPagination() {
  const btn = document.getElementById('loadMoreSongs');
  if (trendingSongsData.length <= trendingSongsPage * itemsPerPage) {
    btn.disabled = true; btn.textContent = 'No More Songs';
  } else {
    btn.disabled = false; btn.textContent = 'Load 10 More';
  }
}

async function loadMoreTrendingSongs() {
  const btn = document.getElementById('loadMoreSongs');
  btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
  await new Promise(r => setTimeout(r, 500));
  trendingSongsPage++;
  renderTrendingSongs(0, trendingSongsPage * itemsPerPage);
  updateSongsPagination();
}

async function loadPersonalizedRecommendations() {
  const div = document.getElementById('personalizedContent');
  div.innerHTML = '<div class="loader"></div>';
  try {
    const data = await getJSONData();
    const users = JSON.parse(data);
    const current = users.find(u => u.Username === loggedInUser.Username);
    if (!current || ((!current.selectedSongs || !current.selectedSongs.length) && (!current.selectedAlbums || !current.selectedAlbums.length))) {
    personalizedDiv.innerHTML = `
          <p class="text-center">No recommendations available yet. Add some songs or albums to your profile first!</p>
          <button class="btn btn-primary d-block mx-auto" onclick="window.location.href='songSearch.html'">Search for Music</button>
        `;
      return;
    }
    const artists = new Set(), genres = new Set();
    (current.selectedSongs || []).forEach(s => { artists.add(s.artist); genres.add(s.genre); });
    (current.selectedAlbums || []).forEach(a => { artists.add(a.artist); genres.add(a.genre); });
    sessionStorage.setItem('userArtists', JSON.stringify([...artists]));
    sessionStorage.setItem('userGenres', JSON.stringify([...genres]));
    let html = '<div class="row">', count = 0, max = 6;
    const pickArray = arr => arr.sort(() => 0.5 - Math.random()).slice(0, 3);
    for (const artist of pickArray([...artists])) {
      if (count>=max) break;
      const resp = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artist)}&media=music&entity=song&limit=2`);
      const resd = await resp.json();
      for (const it of resd.results || []) {
        if (count>=max) break;
        const t = it.trackName.replace(/'/g, "\'"), ar = it.artistName.replace(/'/g, "\'"), col = it.collectionName.replace(/'/g, "\'");
        html += `<div class="col-md-4 mb-4"><div class="card h-100"><div class="position-absolute top-0 end-0 p-2"><button class="btn btn-sm btn-outline-danger" onclick="replaceRecommendation('rec${count}','artist','${artist.replace(/'/g,"\'")}')"><i class="bi bi-x-circle"></i> Replace</button></div><img src="${it.artworkUrl100.replace('100x100','300x300')}" class="card-img-top"><div class="card-body"><h5 class="card-title">${it.trackName}</h5><p class="card-text">Artist: ${it.artistName}</p><p class="card-text">Album: ${it.collectionName}</p><audio controls class="w-100 mb-2"><source src="${it.previewUrl}" type="audio/mpeg"></audio><button class="btn btn-primary w-100" onclick="selectSong('${t}','${ar}','${col}','${it.artworkUrl100}')">Select</button></div></div></div>`;
        count++;
      }
    }
    if (count<max) {
      for (const genre of pickArray([...genres])) {
        if (count>=max) break;
        const resp = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(genre)}&media=music&entity=song&limit=3`);
        const resd = await resp.json();
        for (const it of resd.results || []) {
          if (count>=max) break;
          if ([...artists].includes(it.artistName)) continue;
          const t = it.trackName.replace(/'/g, "\'"), ar = it.artistName.replace(/'/g, "\'"), col = it.collectionName.replace(/'/g, "\'");
          html += `<div class="col-md-4 mb-4"><div class="card h-100"><div class="position-absolute top-0 end-0 p-2"><button class="btn btn-sm btn-outline-danger" onclick="replaceRecommendation('rec${count}','genre','${genre.replace(/'/g,"\'")}')"><i class="bi bi-x-circle"></i> Replace</button></div><img src="${it.artworkUrl100.replace('100x100','300x300')}" class="card-img-top"><div class="card-body"><h5 class="card-title">${it.trackName}</h5><p class="card-text">Artist: ${it.artistName}</p><p class="card-text">Album: ${it.collectionName}</p><audio controls class="w-100 mb-2"><source src="${it.previewUrl}" type="audio/mpeg"></audio><button class="btn btn-primary w-100" onclick="selectSong('${t}','${ar}','${col}','${it.artworkUrl100}')">Select</button></div></div></div>`;
          count++;
        }
      }
    }
    html += '</div>';
    div.innerHTML = html;
  } catch (e) {
    div.innerHTML = '<p class="text-center">Error loading recommendations.</p>';
  }
}

async function replaceRecommendation(recId, sourceType, sourceValue) {
  const card = document.getElementById(recId);
  if (!card) return;
  const orig = card.innerHTML;
  card.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="loader"></div></div>';
  try {
    const artists = JSON.parse(sessionStorage.getItem('userArtists')||'[]');
    const genres = JSON.parse(sessionStorage.getItem('userGenres')||'[]');
    let fetchType = sourceType, fetchValue = sourceValue;
    if (sourceType==='artist') {
      const others = artists.filter(a=>a!==sourceValue);
      if (others.length){ fetchValue=others[Math.floor(Math.random()*others.length)]; }
      else if (genres.length){ fetchType='genre'; fetchValue=genres[Math.floor(Math.random()*genres.length)]; }
    } else {
      const others = genres.filter(g=>g!==sourceValue);
      if (others.length){ fetchValue=others[Math.floor(Math.random()*others.length)]; }
      else if (artists.length){ fetchType='artist'; fetchValue=artists[Math.floor(Math.random()*artists.length)]; }
    }
    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(fetchValue)}&media=music&entity=song&limit=5`);
    const data = await res.json();
    let valid = data.results.find(r=>!(artists.includes(r.artistName))) || data.results[0];
    if (!valid) throw new Error();
    const t = valid.trackName.replace(/'/g, "\'"), ar=valid.artistName.replace(/'/g,"\'"), col=valid.collectionName.replace(/'/g,"\'");
    card.innerHTML= `<div class="card h-100"><div class="position-absolute top-0 end-0 p-2"><button class="btn btn-sm btn-outline-danger" onclick="replaceRecommendation('${recId}','${fetchType}','${fetchValue.replace(/'/g,"\'")}')"><i class="bi bi-x-circle"></i> Replace</button></div><img src="${valid.artworkUrl100.replace('100x100','300x300')}" class="card-img-top"><div class="card-body"><h5 class="card-title">${valid.trackName}</h5><p class="card-text">Artist: ${valid.artistName}</p><p class="card-text">Album: ${valid.collectionName}</p><audio controls class="w-100 mb-2"><source src="${valid.previewUrl}" type="audio/mpeg"></audio><button class="btn btn-primary w-100" onclick="selectSong('${t}','${ar}','${col}','${valid.artworkUrl100}')">Select</button></div></div>`;
  } catch {
    card.innerHTML = orig;
    alert("Could not replace recommendation.");
  }
}

async function searchAndPreview(songTitle, artistName) {
  try {
    const q = `${encodeURIComponent(songTitle)}%20${encodeURIComponent(artistName)}`;
    const res = await fetch(`https://itunes.apple.com/search?term=${q}&media=music&entity=song&limit=1`);
    const data = await res.json();
    if (!data.results.length) { alert("No preview available."); return; }
    const song = data.results[0];
    const modalId = 'modal'+Date.now();
    const modal = document.createElement('div');
    modal.className='modal fade'; modal.id=modalId;
    modal.innerHTML = `<div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">${song.trackName} - ${song.artistName}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><img src="${song.artworkUrl100.replace('100x100','300x300')}" class="img-fluid mb-3"><audio controls autoplay class="w-100"><source src="${song.previewUrl}" type="audio/mpeg"></audio></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-primary" onclick="selectSong('${song.trackName.replace(/'/g,"\'")}','${song.artistName.replace(/'/g,"\'")}','${song.collectionName.replace(/'/g,"\'")}','${song.artworkUrl100}')">Select Song</button></div></div></div>`;
    document.body.append(modal);
    const bsModal = new bootstrap.Modal(document.getElementById(modalId)); bsModal.show();
    document.getElementById(modalId).addEventListener('hidden.bs.modal',()=>modal.remove());
  } catch { alert("Error playing preview."); }
}

function selectSong(track, artist, album, albumArt) {
  selectedSong = { track, artist, album, albumArt };
  alert(`Selected: ${track} by ${artist}`);
  if (!loggedInUser) return;
  const saveBtn = document.createElement('div');
  saveBtn.className='fixed-bottom bg-light p-2 text-center';
  saveBtn.innerHTML = `<p>You've selected "${track}" by ${artist}</p><button class="btn btn-success" onclick="saveSelectedSong()">Save to Your Profile</button>`;
  document.querySelector('.fixed-bottom')?.remove();
  document.body.append(saveBtn);
}

async function saveSelectedSong() {
  if (!selectedSong || !loggedInUser) { alert("Select a song first."); return; }
  try {
    const data = await getJSONData(); const users = JSON.parse(data);
    const idx = users.findIndex(u=>u.Username===loggedInUser.Username);
    if (idx<0) throw "";
    users[idx].selectedSongs = users[idx].selectedSongs||[];
    if (users[idx].selectedSongs.some(s=>s.track===selectedSong.track&&s.artist===selectedSong.artist)) { alert("Already saved."); return; }
    users[idx].selectedSongs.push(selectedSong);
    await putJSONData(users);
    alert("Song saved!");
    document.querySelector('.fixed-bottom')?.remove();
    loadPersonalizedRecommendations();
  } catch { alert("Error saving song."); }
}

function discoverByGenre() {
  const select = document.getElementById('genreSelect');
  const content = document.getElementById('discoverContent');
  content.innerHTML = '<div class="loader"></div>';
  const map = { pop:14, rock:21, hiphop:18, electronic:7, jazz:11, classical:5, country:6, rnb:15 };
  const genres = select.value==='all'? Object.entries(map): [[select.value,map[select.value]]];
  Promise.all(genres.map(([k,id])=>fetch(`https://itunes.apple.com/us/rss/topsongs/limit=50/genre=${id}/json`).then(r=>r.json()).then(d=>({k,entries:d.feed.entry||[]}))))
    .then(results=>{
      content.innerHTML='';
      results.forEach(({k,entries})=>{
        let page=0, per=10;
        const render=()=>{
          const start=page*per, slice=entries.slice(start,start+per);
          let html=`<div class="mb-4"><h4>${k.toUpperCase()}</h4><div class="row">`;
          slice.forEach(item=> {
            const title=item.title.label, artist=item['im:artist'].label, img=item['im:image'][2].label, cat=item.category.attributes.term;
            html+=`<div class="col-md-4 mb-4"><div class="card h-100"><img src="${img}" class="card-img-top"><div class="card-body"><h5>${title}</h5><p>Artist: ${artist}</p><p>Genre: ${cat}</p><button class="btn btn-primary w-100" onclick="searchAndPreview('${title.replace(/'/g,"\'")}','${artist.replace(/'/g,"\'")}')">Listen Preview</button></div></div></div>`;
          });
          html+=`</div><div class="d-flex justify-content-between align-items-center"><button class="btn btn-outline-secondary"${page===0?' disabled':''} onclick="${k}Page--,render()}">Previous</button><span>Page ${page+1}</span><button class="btn btn-outline-secondary"${(page+1)*per>=entries.length?' disabled':''} onclick="${k}Page++,render()}">Next</button></div></div>`;
          content.innerHTML+=html;
        };
        render();
      });
    }).catch(()=>content.innerHTML='<p class="text-center">Error loading genres.</p>');
}
</script>
</body>
</html>